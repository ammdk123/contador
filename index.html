<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sistema de Marcaci√≥n de Taekwondo</title>
    <style>
        /* Cache disable and responsive improvements */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            /* Remove height constraint for scrolling */
            min-height: 100vh;
            height: auto;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .main-container {
            /* Allow scrolling and responsive layout */
            min-height: 100vh;
            height: auto;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .top-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .round-indicator {
            font-size: 48px;
            font-weight: bold;
            color: #333;
        }

        .timer-container {
            position: relative;
        }

        /* Match status text */
        .match-status {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #20b2aa;
            margin-bottom: 10px;
        }

        .timer {
    background: #ddd;
    padding: 20px 40px;
    border-radius: 15px;
    font-size: 72px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    border: 4px solid transparent;
    transition: border-color 0.3s;
    /* Centrado vertical y horizontal para el texto del timer */
    display: flex;
    align-items: center;
    justify-content: center;
}
        .timer.active {
            background: #FFD700 !important;
            border-color: #FFD700 !important;
        }

        /* Timer state colors */
        .timer.rest-mode {
            background: #9d4edd !important;
            color: white !important;
            border-color: #9d4edd !important;
        }

        .timer.match-ended {
            background: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        .timer.paused {
    background: #ccc !important;
    color: #333 !important;
    border-color: #ccc !important;
}

        .wins-display {
            background: #FFD700;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 36px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wins-red {
            color: #FF0000;
        }

        .wins-blue {
            color: #0066FF;
        }

        .wins-separator {
            color: #333;
        }

        .scoring-area {
            display: flex;
            gap: 30px;
            flex: 1;
            align-items: center;
        }

        .competitor {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .competitor-label {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .red-label {
            color: #FF0000;
        }

        .blue-label {
            color: #0066FF;
        }

        .score-box {
            width: 100%;
            height: 300px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 180px;
            font-weight: bold;
            position: relative;
            margin-bottom: 10px;
        }

        .red-box {
            background: #FF3333;
        }

        .blue-box {
            background: #3366FF;
        }

        .penalty-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .penalty-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .penalty-fill.red {
            background: #FF3333;
        }

        .penalty-fill.blue {
            background: #3366FF;
        }

        .competitor-total {
            background: #ddd;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .controls-area {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            font-size: 16px;
            font-weight: bold;
            width: 80px;
            text-align: center;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #666;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: #444;
        }

        .control-value {
            width: 80px;
            text-align: center;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            background: white;
        }

        .bottom-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .left-icons, .right-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .toolbar-icon {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: #666;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }

        .toolbar-icon:hover {
            background: #444;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #666;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .toolbar-btn:hover {
            background: #444;
        }

        .visibility-toggle {
            background: #4CAF50 !important;
        }

        .visibility-toggle.hidden {
            background: #f44336 !important;
        }

        /* Disabled state for controls */
        .controls-disabled .control-btn,
        .controls-disabled .timer {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* New Match button */
        .new-match-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }


        .new-match-btn:hover {
            background: #0056b3;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #007bff;
            color: white;
        }

        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn.red {
            background: #dc3545;
            color: white;
        }

        .modal-btn.blue {
            background: #007bff;
            color: white;
        }

        .modal-btn:hover {
            opacity: 0.8;
        }

        /* Settings Modal */
        .settings-modal {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-modal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
            text-align: left;
        }

        .settings-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .settings-label {
            font-size: 16px;
            color: #555;
        }

        .settings-input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }

        .settings-checkbox {
            transform: scale(1.2);
        }

        .gamepad-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .gamepad-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .gamepad-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }

        .mapping-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .mapping-row:last-child {
            border-bottom: none;
        }

        .button-name {
            font-weight: bold;
            color: #007bff;
            min-width: 80px;
            font-size: 14px;
        }

        .button-action {
            color: #495057;
            text-align: right;
            flex: 1;
            font-size: 14px;
        }

        .control-mapping {
            background: white;
            border-radius: 5px;
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .hidden {
            display: none !important;
        }

        .controls-hidden .controls-area {
            display: none;
        }

        /* Mobile responsiveness */
        @media screen and (max-width: 768px) {
            .main-container {
                padding: 5px;
            }
            
            .top-section {
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .round-indicator {
                font-size: 32px;
            }
            
            .timer {
                font-size: 48px;
                padding: 15px 25px;
            }
            
            .wins-display {
                font-size: 24px;
                padding: 10px 15px;
            }
            
            .scoring-area {
                flex-direction: column;
                gap: 20px;
            }
            
            .competitor-label {
                font-size: 24px;
            }
            
            .score-box {
                height: 200px;
                font-size: 120px;
            }
            
            .controls-area {
                gap: 20px;
                margin: 20px 0;
            }
            
            .bottom-toolbar {
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            
            .match-status {
                font-size: 18px;
            }
        }

        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .timer {
                font-size: 56px;
            }
            
            .score-box {
                font-size: 140px;
            }
        }


        .new-match-btn {
    background: #007bff !important;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: background 0.2s;
}
.new-match-btn:hover {
    background: #0056b3 !important;
}
/* Extiende disabled state para incluir new-match-btn */
.controls-disabled .toolbar-btn,
.controls-disabled .new-match-btn {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.controls-disabled .new-match-btn {
    opacity: 1 !important;
    cursor: pointer !important;
    pointer-events: auto !important;
    background: #007bff !important; /* Mantiene el color azul visible */
}

/* Mobile: Ajusta tama√±o de botones en toolbar */
@media screen and (max-width: 768px) {
    .toolbar-btn, .new-match-btn {
        padding: 6px 12px;
        font-size: 12px;
    }
}

.display-mode .bottom-toolbar,
.display-mode .controls-area {
    display: none !important;
}
.display-mode .controls-hidden .controls-area {
    display: none !important;  /* Redundante, pero asegura */
}
/* Opcional: Ajusta layout para modo display (m√°s espacio para scores/timer) */
.display-mode .scoring-area {
    gap: 50px;  /* M√°s espacio entre competidores */
}
.display-mode .top-section {
    margin-bottom: 50px;  /* M√°s margen para timer */
}

.display-mode .timer {
    cursor: default !important;
    pointer-events: none !important;
}
.display-mode .modal {
    display: none !important;  /* Oculta modales en externa; √∫salos solo en principal */
}

/* Nuevos estilos para indicador de validaci√≥n de puntos */
.validation-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    color: #ff6b35;
    display: none;
}

.validation-indicator.active {
    display: block;
}

.multicontroller-status {
    background: #e7f3ff;
    border: 1px solid #b3d7ff;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    text-align: center;
}

.controller-list {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
    flex-wrap: wrap;
    gap: 10px;
}

.controller-item {
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    min-width: 120px;
    text-align: center;
}

.controller-item.connected {
    border-color: #28a745;
    background: #d4edda;
}

.controller-item.active {
    border-color: #007bff;
    background: #cce7ff;
}

    </style>
</head>
<body>
    <div class="main-container" id="mainContainer">
        <div class="top-section">
            <div class="round-indicator">ROUND <span id="currentRound">1</span></div>
            <div class="timer-container">
                <div class="match-status hidden" id="matchStatus">ROUND 1 - MATCH ENDED</div>
                <div class="timer" id="timer" onclick="toggleTimer()">2:00</div>
                <div class="validation-indicator" id="validationIndicator">Validando puntos...</div>
            </div>
            <div class="wins-display" id="winsDisplay">
                <span class="wins-red" id="redWins">0</span>
                <span class="wins-separator">-</span>
                <span class="wins-blue" id="blueWins">0</span>
            </div>
        </div>

        <div class="scoring-area">
            <div class="competitor">
                <div class="competitor-label red-label">RED</div>
                <div class="score-box red-box" id="redScore">0</div>
                <div class="penalty-bar">
                    <div class="penalty-fill red" id="redPenaltyBar"></div>
                </div>
                <div class="competitor-total" id="redTotal">0</div>
            </div>

            <div class="controls-area" id="controlsArea">
                <div class="control-section">
                    <div class="control-row">
                        <div class="control-label">PUNTOS</div>
                    </div>
                    <div class="control-row">
                        <button class="control-btn" onclick="changePoints('red', -1)">‚àí</button>
                        <input type="text" class="control-value" id="redPoints" value="0" readonly>
                        <button class="control-btn" onclick="changePoints('red', 1)">+</button>
                    </div>
                    <div class="control-row">
                        <div class="control-label">PENALTY</div>
                    </div>
                    <div class="control-row">
                        <button class="control-btn" onclick="changePenalties('red', -1)">‚àí</button>
                        <input type="text" class="control-value" id="redPenalties" value="1" readonly>
                        <button class="control-btn" onclick="changePenalties('red', 1)">+</button>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-row">
                        <div class="control-label">PUNTOS</div>
                    </div>
                    <div class="control-row">
                        <button class="control-btn" onclick="changePoints('blue', -1)">‚àí</button>
                        <input type="text" class="control-value" id="bluePoints" value="0" readonly>
                        <button class="control-btn" onclick="changePoints('blue', 1)">+</button>
                    </div>
                    <div class="control-row">
                        <div class="control-label">PENALTY</div>
                    </div>
                    <div class="control-row">
                        <button class="control-btn" onclick="changePenalties('blue', -1)">‚àí</button>
                        <input type="text" class="control-value" id="bluePenalties" value="1" readonly>
                        <button class="control-btn" onclick="changePenalties('blue', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="competitor">
                <div class="competitor-label blue-label">BLUE</div>
                <div class="score-box blue-box" id="blueScore">0</div>
                <div class="penalty-bar">
                    <div class="penalty-fill blue" id="bluePenaltyBar"></div>
                </div>
                <div class="competitor-total" id="blueTotal">0</div>
            </div>
        </div>

        <div class="bottom-toolbar">
    <div class="left-icons">           
    <button class="toolbar-icon" onclick="showSettings()" title="Configuraci√≥n">‚öô</button>
    <button class="toolbar-icon" onclick="toggleFullscreen()" title="Pantalla completa">‚õ∂</button>
    <button class="toolbar-icon" onclick="openExternalDisplay()" title="Abrir en Pantalla Externa">üñ•Ô∏è</button>  <!-- Nuevo bot√≥n -->
</div>
    <div class="center-icon">
        <button class="toolbar-icon visibility-toggle" id="visibilityToggle" onclick="toggleControlsVisibility()" title="Ocultar/Mostrar controles">üìù</button>
    </div>
    <div class="right-icons">
        <button class="toolbar-btn" id="endMatchBtn" onclick="endMatch()">End Match</button>    
        <button class="new-match-btn hidden" id="newMatchBtn" onclick="startNewMatch()">New Match</button>
    </div>
</div>

        
    </div>

    <!-- Modals -->
    <div id="timeWinModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">Seleccionar ganador ‚Äî Victoria por tiempo</div>
            <div class="modal-buttons">
                <button class="modal-btn red" onclick="confirmTimeWin('red')">RED</button>
                <button class="modal-btn blue" onclick="confirmTimeWin('blue')">BLUE</button>
            </div>
        </div>
    </div>

    <div id="penaltyWinModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">Seleccionar ganador ‚Äî Victoria por descalificaci√≥n por penalizaciones</div>
            <div class="modal-buttons">
                <button class="modal-btn red" id="penaltyWinRed" onclick="confirmPenaltyWin('red')">RED</button>
                <button class="modal-btn blue" id="penaltyWinBlue" onclick="confirmPenaltyWin('blue')">BLUE</button>
            </div>
        </div>
    </div>

    <div id="roundEndModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title" id="roundEndTitle">¬øConfirmar victoria de RED en el round?</div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('roundEndModal')">Cancelar</button>
                <button class="modal-btn primary" onclick="confirmRoundEnd()">Confirmar y terminar round</button>
                <button class="modal-btn primary" onclick="confirmMatchEnd()">Confirmar y terminar pelea</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal hidden">
        <div class="modal-content settings-modal">
            <div class="modal-title">CONFIGURACI√ìN</div>
            
            <div class="settings-section">
                <div class="settings-title">JUECES</div>
                <div class="settings-row">
                    <span class="settings-label">Tiempo por round (segundos)</span>
                    <input type="number" class="settings-input" id="roundTime" value="120">
                </div>
                <div class="settings-row">
                    <span class="settings-label">Rounds para ganar</span>
                    <input type="number" class="settings-input" id="roundsToWin" value="2">
                </div>
                <div class="settings-row">
                    <span class="settings-label">L√≠mite de penalizaciones</span>
                    <input type="number" class="settings-input" id="penaltyLimit" value="5">
                </div>
                <div class="settings-row">
                    <span class="settings-label">Tiempo de descanso (segundos)</span>
                    <input type="number" class="settings-input" id="restTime" value="60">
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">PANTALLA</div>
                <div class="settings-row">
                    <span class="settings-label">Restablecer puntuaci√≥n entre rounds</span>
                    <input type="checkbox" class="settings-checkbox" id="resetScoreBetweenRounds" checked>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Restablecer penalizaciones entre rounds</span>
                    <input type="checkbox" class="settings-checkbox" id="resetPenaltiesBetweenRounds" checked>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Seguir ganadores de round</span>
                    <input type="checkbox" class="settings-checkbox" id="trackRoundWinners" checked>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">CONTROLES M√öLTIPLES</div>
                <div class="settings-row">
                    <span class="settings-label">Sistema de m√∫ltiples controles</span>
                    <input type="checkbox" class="settings-checkbox" id="enableMultiController" checked>
                </div>
                <div class="multicontroller-status" id="multiControllerStatus">
                    <div><strong>Estado de Controles (2-3 controles requeridos)</strong></div>
                    <div class="controller-list" id="controllerList"></div>
                </div>
                
                <div id="gamepadControls" class="gamepad-controls" style="margin-top: 15px;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #333;">Controles Mapeados (por control):</div>
                    <div class="control-mapping">
                        <div style="margin-bottom: 15px;">
                            <strong>JUGADOR AZUL:</strong>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ D-Pad ‚Üë</span>
                                <span class="button-action">+1 Punto AZUL</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ D-Pad ‚Üí</span>
                                <span class="button-action">+2 Puntos AZUL</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ D-Pad ‚Üì</span>
                                <span class="button-action">+3 Puntos AZUL</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ D-Pad ‚Üê</span>
                                <span class="button-action">+4 Puntos AZUL</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ Stick Izq (Click)</span>
                                <span class="button-action">+5 Puntos AZUL</span>
                            </div>
                        </div>
                        <div>
                            <strong>JUGADOR ROJO:</strong>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ LB</span>
                                <span class="button-action">+1 Punto ROJO</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ RB</span>
                                <span class="button-action">+2 Puntos ROJO</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ LT</span>
                                <span class="button-action">+3 Puntos ROJO</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ RT</span>
                                <span class="button-action">+4 Puntos ROJO</span>
                            </div>
                            <div class="mapping-row">
                                <span class="button-name">üéÆ Stick Der (Click)</span>
                                <span class="button-action">+5 Puntos ROJO</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                        <strong>Nota:</strong> Para usar m√∫ltiples controles:
                        <ol style="margin: 5px 0 0 20px;">
                            <li>Conecta 2-3 controles de Xbox por USB o Bluetooth</li>
                            <li>Presiona cualquier bot√≥n en cada control para activarlos</li>
                            <li>Las marcaciones requieren consenso de al menos 2 controles</li>
                            <li>Delay de 2 segundos para confirmaci√≥n entre jueces</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 1px solid #dee2e6; margin-top: 20px;">
                <button class="modal-btn secondary" onclick="closeModal('settingsModal')">Cancelar</button>
                <button class="modal-btn primary" onclick="saveSettings()">Guardar y iniciar nueva pelea</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            currentRound: 1,
            redScore: 0,
            blueScore: 0,
            redPenalties: 0,
            bluePenalties: 0,
            redWins: 0,
            blueWins: 0,
            timeRemaining: 120,
            isTimerRunning: false,
            timerInterval: null,
            controlsVisible: true,
            isRestTime: false,
            isMatchEnded: false,
            controlsDisabled: false
        };

        // Settings
        let settings = {
            roundTime: 120,
            roundsToWin: 2,
            penaltyLimit: 5,
            resetScoreBetweenRounds: true,
            resetPenaltiesBetweenRounds: true,
            trackRoundWinners: true,
            enableGamepad: true,
            enableMultiController: true,
            restTime: 60
        };

        let broadcastChannel = null;
        if (typeof BroadcastChannel !== 'undefined') {
            broadcastChannel = new BroadcastChannel('taekwondo-sync');
        }

        // Multi-controller support
        let connectedControllers = {};
        let pendingActions = {};
        let validationTimeout = null;
        let stopPolling = false;
        // Sistema de validaci√≥n de puntos
        function addPendingAction(controllerId, action) {
    if (!settings.enableMultiController) {
        executeAction(action);
        return;
    }

    const actionKey = `${action.type}_${action.target}_${action.points}`;
    console.log(`Control ${controllerId} env√≠a: ${actionKey}`);
    
    if (!pendingActions[actionKey]) {
        pendingActions[actionKey] = {
            action: action,
            controllers: [controllerId],
            timestamp: Date.now()
        };
        console.log(`Nueva acci√≥n pendiente: ${actionKey}`);
    } else {
        if (!pendingActions[actionKey].controllers.includes(controllerId)) {
            pendingActions[actionKey].controllers.push(controllerId);
            console.log(`Control ${controllerId} confirma: ${actionKey} (${pendingActions[actionKey].controllers.length} confirmaciones)`);
        }
    }

    showValidationIndicator();

    if (validationTimeout) {
        clearTimeout(validationTimeout);
    }
    
    validationTimeout = setTimeout(() => {
        validatePendingActions();
    }, 2000);
}

             function validatePendingActions() {
         const totalConnected = Object.keys(connectedControllers).filter(id => connectedControllers[id].connected).length;
         
         if (settings.enableMultiController && totalConnected < 2) {
             console.log('Multi activo pero <2 controles: Ignorando acciones pendientes');
             pendingActions = {};
             hideValidationIndicator();
             return;
         }
         
         const requiredConsensus = settings.enableMultiController ? 2 : 1;  // Fuerza 2 en multi, 1 en manual
         console.log(`Total conectados: ${totalConnected}, Requerido: ${requiredConsensus}`);  // Log para debug
         
         for (const actionKey in pendingActions) {
             const pending = pendingActions[actionKey];
             
             console.log(`Validando ${actionKey}: ${pending.controllers.length} de ${requiredConsensus} requeridos`);
             
             if (pending.controllers.length >= requiredConsensus) {
                 executeAction(pending.action);
                 console.log(`‚úì Acci√≥n ejecutada: ${actionKey}`);
             } else {
                 console.log(`‚úó Acci√≥n rechazada: ${actionKey} - insuficiente consenso`);
             }
         }
         
         // Limpiar acciones pendientes
         pendingActions = {};
         hideValidationIndicator();
     }
     

        function executeAction(action) {
            if (gameState.isMatchEnded) return;
            
                 console.log('Ejecutando acci√≥n:', action);  // Log para debug
     if (action.type === 'points') {
         console.log(`Sumando ${action.points} puntos a ${action.target}. Nuevo score: ${action.target === 'red' ? gameState.redScore + action.points : gameState.blueScore + action.points}`);
     }
     

            switch (action.type) {
                case 'points':
                    if (action.target === 'red') {
                        gameState.redScore = Math.max(0, gameState.redScore + action.points);
                    } else {
                        gameState.blueScore = Math.max(0, gameState.blueScore + action.points);
                    }
                    break;
                case 'penalty':
                    if (action.target === 'red') {
                        gameState.redPenalties = Math.max(0, gameState.redPenalties + action.points);
                        if (gameState.redPenalties >= settings.penaltyLimit) {
                            showPenaltyWinModal('blue');
                        }
                    } else {
                        gameState.bluePenalties = Math.max(0, gameState.bluePenalties + action.points);
                        if (gameState.bluePenalties >= settings.penaltyLimit) {
                            showPenaltyWinModal('red');
                        }
                    }
                    break;
            }
            console.log('Display actualizado despu√©s de acci√≥n');
            updateDisplay();
        }

        function showValidationIndicator() {
            document.getElementById('validationIndicator').classList.add('active');
        }

        function hideValidationIndicator() {
            document.getElementById('validationIndicator').classList.remove('active');
        }

        // Gamepad Support con mapeo espec√≠fico
        function initMultiController() {
            window.addEventListener('gamepadconnected', (e) => {
                const controllerId = e.gamepad.index;
                connectedControllers[controllerId] = {
                    connected: true,
                    gamepad: e.gamepad,
                    lastButtonStates: {}
                };
                updateControllerStatus();
                console.log(`Control ${controllerId} conectado:`, e.gamepad.id);
            });

            window.addEventListener('gamepaddisconnected', (e) => {
                const controllerId = e.gamepad.index;
                if (connectedControllers[controllerId]) {
                    connectedControllers[controllerId].connected = false;
                    updateControllerStatus();
                    console.log(`Control ${controllerId} desconectado`);
                }
            });

            if (settings.enableMultiController) {
                stopPolling = false;
                pollMultipleGamepads();
            }
        }

        function updateControllerStatus() {
    const statusContainer = document.getElementById('controllerList');
    const totalConnected = Object.keys(connectedControllers).filter(id => connectedControllers[id].connected).length;
    
    statusContainer.innerHTML = '';
    
    for (let i = 0; i < 3; i++) {
        const controllerDiv = document.createElement('div');
        controllerDiv.className = 'controller-item';
        
        const isConnected = connectedControllers[i] && connectedControllers[i].connected;
        
        if (isConnected) {
            controllerDiv.classList.add('connected');
            controllerDiv.innerHTML = `
                <div><strong>Control ${i + 1}</strong></div>
                <div>‚úì Conectado</div>
            `;
        } else {
            controllerDiv.innerHTML = `
                <div><strong>Control ${i + 1}</strong></div>
                <div>‚ö™ Desconectado</div>
            `;
        }
        
        statusContainer.appendChild(controllerDiv);
    }

    // Actualizar estado general (sin cambios)
    const statusElement = document.getElementById('multiControllerStatus');
    const statusText = statusElement.querySelector('div');
    
    if (totalConnected >= 2) {
        statusText.innerHTML = `<strong>‚úì Sistema Activo (${totalConnected}/3 controles conectados)</strong>`;
        statusElement.style.borderColor = '#28a745';
        statusElement.style.background = '#d4edda';
    } else if (totalConnected === 1) {
        statusText.innerHTML = `<strong>‚ö† Necesita m√°s controles (${totalConnected}/3 controles - m√≠nimo 2)</strong>`;
        statusElement.style.borderColor = '#ffc107';
        statusElement.style.background = '#fff3cd';
    } else {
        statusText.innerHTML = `<strong>‚ùå Sin controles detectados (0/3 controles)</strong>`;
        statusElement.style.borderColor = '#dc3545';
        statusElement.style.background = '#f8d7da';
    }
}


        function pollMultipleGamepads() {
            if (!settings.enableMultiController) return;
            if (stopPolling) return;

            const gamepads = navigator.getGamepads();
            
                 for (let i = 0; i < gamepads.length && i < 3; i++) {
         if (gamepads[i] && connectedControllers[i] && connectedControllers[i].connected) {
             const gamepad = gamepads[i];
             const lastStates = connectedControllers[i].lastButtonStates;
             
             // Mapeo AZUL (D-Pad y Left Stick) - com√∫n para TODOS los controles
             checkButtonPress(gamepad, 12, lastStates, 'dpad_up', i, () => {
                 addPendingAction(i, { type: 'points', target: 'blue', points: 1 });
             });
             checkButtonPress(gamepad, 15, lastStates, 'dpad_right', i, () => {
                 addPendingAction(i, { type: 'points', target: 'blue', points: 2 });
             });
             checkButtonPress(gamepad, 13, lastStates, 'dpad_down', i, () => {
                 addPendingAction(i, { type: 'points', target: 'blue', points: 3 });
             });
             checkButtonPress(gamepad, 14, lastStates, 'dpad_left', i, () => {
                 addPendingAction(i, { type: 'points', target: 'blue', points: 4 });
             });
             // Left Stick Click (bot√≥n 10, digital)
             if (gamepad.buttons[10] && gamepad.buttons[10].pressed && !lastStates['lstick']) {
                 addPendingAction(i, { type: 'points', target: 'blue', points: 5 });
                 lastStates['lstick'] = true;
                 console.log(`Control ${i}: Left Stick presionado (+5 azul)`);
             } else if (!gamepad.buttons[10] || !gamepad.buttons[10].pressed) {
                 lastStates['lstick'] = false;
             }
             
             // Mapeo ROJO (Bumpers, Triggers, Right Stick) - com√∫n para TODOS los controles
             checkButtonPress(gamepad, 4, lastStates, 'lb', i, () => {
                 addPendingAction(i, { type: 'points', target: 'red', points: 1 });
             });
             checkButtonPress(gamepad, 5, lastStates, 'rb', i, () => {
                 addPendingAction(i, { type: 'points', target: 'red', points: 2 });
             });
             // LT (trigger anal√≥gico, bot√≥n 6) - usa value > 0.5
             if (gamepad.buttons[6] && gamepad.buttons[6].value > 0.5 && !lastStates['lt']) {
                 addPendingAction(i, { type: 'points', target: 'red', points: 3 });
                 lastStates['lt'] = true;
                 console.log(`Control ${i}: LT presionado (+3 rojo)`);
             } else if (gamepad.buttons[6] && gamepad.buttons[6].value <= 0.5) {
                 lastStates['lt'] = false;
             }
             // RT (trigger anal√≥gico, bot√≥n 7) - usa value > 0.5
             if (gamepad.buttons[7] && gamepad.buttons[7].value > 0.5 && !lastStates['rt']) {
                 addPendingAction(i, { type: 'points', target: 'red', points: 4 });
                 lastStates['rt'] = true;
                 console.log(`Control ${i}: RT presionado (+4 rojo)`);
             } else if (gamepad.buttons[7] && gamepad.buttons[7].value <= 0.5) {
                 lastStates['rt'] = false;
             }
             // Right Stick Click (bot√≥n 11, digital)
             if (gamepad.buttons[11] && gamepad.buttons[11].pressed && !lastStates['rstick']) {
                 addPendingAction(i, { type: 'points', target: 'red', points: 5 });
                 lastStates['rstick'] = true;
                 console.log(`Control ${i}: Right Stick presionado (+5 rojo)`);
             } else if (!gamepad.buttons[11] || !gamepad.buttons[11].pressed) {
                 lastStates['rstick'] = false;
             }
             
             // Actualiza lastStates para botones digitales (D-Pad, LB, RB)
             const digitalButtons = { dpad_up: 12, dpad_right: 15, dpad_down: 13, dpad_left: 14, lb: 4, rb: 5 };
             Object.keys(digitalButtons).forEach(btnName => {
                 const index = digitalButtons[btnName];
                 if (gamepad.buttons[index]) {
                     lastStates[btnName] = gamepad.buttons[index].pressed;
                 }
             });
         }
     }
     
            
            requestAnimationFrame(pollMultipleGamepads);
        }

        function checkButtonPress(gamepad, buttonIndex, lastStates, buttonName, controllerId, callback) {
            if (gamepad.buttons[buttonIndex]) {
                const isPressed = gamepad.buttons[buttonIndex].pressed;
                const wasPressed = lastStates[buttonName] || false;
                
                if (isPressed && !wasPressed) {
                    callback();
                }
                
                lastStates[buttonName] = isPressed;
            }
        }

        // Funciones originales modificadas para trabajar con multi-controller
        function changePoints(competitor, change) {
            if (!settings.enableMultiController) {
                // Modo manual - ejecuta inmediatamente
                if (gameState.isMatchEnded) return;
                
                if (competitor === 'red') {
                    gameState.redScore = Math.max(0, gameState.redScore + change);
                } else {
                    gameState.blueScore = Math.max(0, gameState.blueScore + change);
                }
                updateDisplay();
            }
            // En modo multi-controller, solo los controles pueden marcar puntos
        }

        function changePenalties(competitor, change) {
            if (gameState.isMatchEnded) return;
            
            if (competitor === 'red') {
                gameState.redPenalties = Math.max(0, gameState.redPenalties + change);
                if (gameState.redPenalties >= settings.penaltyLimit) {
                    showPenaltyWinModal('blue');
                }
            } else {
                gameState.bluePenalties = Math.max(0, gameState.bluePenalties + change);
                if (gameState.bluePenalties >= settings.penaltyLimit) {
                    showPenaltyWinModal('red');
                }
            }
            updateDisplay();
        }

        // Resto del c√≥digo original sin cambios...
        
        // Disable cache function
        function disableCache() {
            // Clear localStorage scoreboard data on page load
            localStorage.removeItem('taekwondoGameState');
            localStorage.removeItem('taekwondoSettings');
            
            // Prevent back/forward cache
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    window.location.reload();
                }
            });
        }

        // Auto-rotate to landscape on mobile devices
        function requestLandscape() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(err => {
                    console.log('Could not lock orientation:', err);
                });
            }
        }

        function loadSettings() {
            gameState.timeRemaining = settings.roundTime;
            updateSettingsForm();
        }

        function saveSettings() {
            // Get values from form
            settings.roundTime = parseInt(document.getElementById('roundTime').value);
            settings.roundsToWin = parseInt(document.getElementById('roundsToWin').value);
            settings.penaltyLimit = parseInt(document.getElementById('penaltyLimit').value);
            settings.restTime = parseInt(document.getElementById('restTime').value);
            settings.resetScoreBetweenRounds = document.getElementById('resetScoreBetweenRounds').checked;
            settings.resetPenaltiesBetweenRounds = document.getElementById('resetPenaltiesBetweenRounds').checked;
            settings.trackRoundWinners = document.getElementById('trackRoundWinners').checked;
            settings.enableMultiController = document.getElementById('enableMultiController').checked;

            // Reset match
            startNewMatch();
            closeModal('settingsModal');
            
            if (settings.enableMultiController) {
                initMultiController();
            }
        }

        function updateSettingsForm() {
            document.getElementById('roundTime').value = settings.roundTime;
            document.getElementById('roundsToWin').value = settings.roundsToWin;
            document.getElementById('penaltyLimit').value = settings.penaltyLimit;
            document.getElementById('restTime').value = settings.restTime;
            document.getElementById('resetScoreBetweenRounds').checked = settings.resetScoreBetweenRounds;
            document.getElementById('resetPenaltiesBetweenRounds').checked = settings.resetPenaltiesBetweenRounds;
            document.getElementById('trackRoundWinners').checked = settings.trackRoundWinners;
            document.getElementById('enableMultiController').checked = settings.enableMultiController;
        }

        function resetMatch() {
            gameState = {
                currentRound: 1,
                redScore: 0,
                blueScore: 0,
                redPenalties: 0,
                bluePenalties: 0,
                redWins: 0,
                blueWins: 0,
                timeRemaining: settings.roundTime,
                isTimerRunning: false,
                timerInterval: null,
                controlsVisible: true,
                isRestTime: false,
                isMatchEnded: false,
                controlsDisabled: false
            };
            updateDisplay();
            document.getElementById('newMatchBtn').classList.add('hidden');
            document.getElementById('endMatchBtn').classList.remove('hidden');
        }

        function startNewMatch() {
            gameState = {
                currentRound: 1,
                redScore: 0,
                blueScore: 0,
                redPenalties: 0,
                bluePenalties: 0,
                redWins: 0,
                blueWins: 0,
                timeRemaining: settings.roundTime,
                isTimerRunning: false,
                timerInterval: null,
                controlsVisible: true,
                isRestTime: false,
                isMatchEnded: false,
                controlsDisabled: false
            };
            document.getElementById('newMatchBtn').classList.add('hidden');
            document.getElementById('endMatchBtn').classList.remove('hidden');
            updateDisplay();
        }

        function updateDisplay() {
            // Update scores
            document.getElementById('redScore').textContent = gameState.redScore;
            document.getElementById('blueScore').textContent = gameState.blueScore;
            document.getElementById('redTotal').textContent = gameState.redPenalties;
            document.getElementById('blueTotal').textContent = gameState.bluePenalties;

            // Update points/penalties controls
            document.getElementById('redPoints').value = gameState.redScore;
            document.getElementById('bluePoints').value = gameState.blueScore;
            document.getElementById('redPenalties').value = gameState.redPenalties;
            document.getElementById('bluePenalties').value = gameState.bluePenalties;

            // Update penalty bars
            const redPenaltyPercent = (gameState.redPenalties / settings.penaltyLimit) * 100;
            const bluePenaltyPercent = (gameState.bluePenalties / settings.penaltyLimit) * 100;
            document.getElementById('redPenaltyBar').style.width = redPenaltyPercent + '%';
            document.getElementById('bluePenaltyBar').style.width = bluePenaltyPercent + '%';

            // Update timer
            const minutes = Math.floor(gameState.timeRemaining / 60);
            const seconds = gameState.timeRemaining % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Update round and wins
            document.getElementById('currentRound').textContent = gameState.currentRound;
            document.getElementById('redWins').textContent = gameState.redWins;
            document.getElementById('blueWins').textContent = gameState.blueWins;

            // Update timer appearance and match status
            const timerElement = document.getElementById('timer');
            const matchStatusElement = document.getElementById('matchStatus');
            const mainContainer = document.getElementById('mainContainer');

            timerElement.classList.remove('active', 'rest-mode', 'match-ended', 'paused');
            
            if (gameState.isMatchEnded) {
                timerElement.classList.add('match-ended');
                matchStatusElement.textContent = `ROUND ${gameState.currentRound} - MATCH ENDED`;
                matchStatusElement.classList.remove('hidden');
                mainContainer.classList.add('controls-disabled');
            } else if (gameState.isRestTime) {
                timerElement.classList.add('rest-mode');
                matchStatusElement.textContent = `ROUND ${gameState.currentRound} - BREAK`;
                matchStatusElement.classList.remove('hidden');
                mainContainer.classList.remove('controls-disabled');
                
                if (!gameState.isTimerRunning) {
                    timerElement.classList.add('paused');
                }
            } else {
                if (gameState.isTimerRunning) {
                    timerElement.classList.add('active');
                }
                matchStatusElement.classList.add('hidden');
                mainContainer.classList.remove('controls-disabled');
            }

            if (broadcastChannel) {
                broadcastChannel.postMessage({
                    type: 'update',
                    gameState: { ...gameState },
                    settings: { ...settings }
                });
            }
        }

        function toggleTimer() {
            if (gameState.isMatchEnded) return;
            
            if (gameState.isTimerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            const urlParams = new URLSearchParams(window.location.search);
            const isDisplayMode = urlParams.get('mode') === 'display';
            if (isDisplayMode) {
                console.log('startTimer bloqueado en modo display');
                return;
            }
            
            if (gameState.timeRemaining <= 0 || gameState.isMatchEnded) return;
            
            gameState.isTimerRunning = true;
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateDisplay();
                
                if (gameState.timeRemaining <= 0) {
                    pauseTimer();
                    if (gameState.isRestTime) {
                        startNextRound();
                    } else {
                        showTimeWinModal();
                    }
                }
            }, 1000);
            updateDisplay();
        }

        function pauseTimer() {
            const urlParams = new URLSearchParams(window.location.search);
            const isDisplayMode = urlParams.get('mode') === 'display';
            if (isDisplayMode && gameState.isTimerRunning) {
                console.log('pauseTimer forzado en modo display via sync');
            } else if (isDisplayMode) {
                return;
            }
            
            gameState.isTimerRunning = false;
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            updateDisplay();
        }

        function showTimeWinModal() {
            document.getElementById('timeWinModal').classList.remove('hidden');
        }

        function confirmTimeWin(winner) {
            if (winner === 'red') {
                gameState.redWins++;
            } else {
                gameState.blueWins++;
            }
            
            closeModal('timeWinModal');
            
            if (checkMatchWinner()) {
                showMatchEndModal(winner);
            } else {
                startNewRound();
            }
            updateDisplay();
        }

        function showPenaltyWinModal(winner) {
            document.getElementById('penaltyWinModal').classList.remove('hidden');
        }

        function confirmPenaltyWin(winner) {
            if (winner === 'red') {
                gameState.redWins++;
            } else {
                gameState.blueWins++;
            }
            
            closeModal('penaltyWinModal');
            
            if (checkMatchWinner()) {
                showMatchEndModal(winner);
            } else {
                startNewRound();
            }
            updateDisplay();
        }

        function checkMatchWinner() {
            return gameState.redWins >= settings.roundsToWin || gameState.blueWins >= settings.roundsToWin;
        }

        function startNewRound() {
            gameState.isRestTime = true;
            gameState.timeRemaining = settings.restTime;
            gameState.isTimerRunning = false;
            
            if (settings.resetScoreBetweenRounds) {
                gameState.redScore = 0;
                gameState.blueScore = 0;
            }
            
            if (settings.resetPenaltiesBetweenRounds) {
                gameState.redPenalties = 0;
                gameState.bluePenalties = 0;
            }
            
            pauseTimer();
            updateDisplay();
        }

        function startNextRound() {
            gameState.currentRound++;
            gameState.isRestTime = false;
            gameState.timeRemaining = settings.roundTime;
            gameState.isTimerRunning = false;
            
            pauseTimer();
            updateDisplay();
        }

        function showMatchEndModal(winner) {
            const modal = document.getElementById('roundEndModal');
            const title = document.getElementById('roundEndTitle');
            title.textContent = `¬øConfirmar victoria de ${winner.toUpperCase()} en la pelea?`;
            modal.classList.remove('hidden');
        }

        function confirmRoundEnd() {
            startNewRound();
            closeModal('roundEndModal');
        }

        function confirmMatchEnd() {
            alert('¬°Pelea terminada!');
            resetMatch();
            closeModal('roundEndModal');
        }

        function toggleControlsVisibility() {
            gameState.controlsVisible = !gameState.controlsVisible;
            const mainContainer = document.getElementById('mainContainer');
            const visibilityToggle = document.getElementById('visibilityToggle');
            
            if (gameState.controlsVisible) {
                mainContainer.classList.remove('controls-hidden');
                visibilityToggle.textContent = "üìù";
                visibilityToggle.classList.add('visibility-toggle');
            } else {
                mainContainer.classList.add('controls-hidden');
                visibilityToggle.textContent = "üëÅÔ∏è";
                visibilityToggle.classList.remove('visibility-toggle');
            }
        }

        function showSettings() {
            updateSettingsForm();
            updateControllerStatus();
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function endMatch() {
            if (confirm('¬øEst√° seguro de que desea terminar la pelea?')) {
                gameState.isMatchEnded = true;
                pauseTimer();
                document.getElementById('endMatchBtn').classList.add('hidden');
                document.getElementById('newMatchBtn').classList.remove('hidden');
                updateDisplay();
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Error activando pantalla completa:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openExternalDisplay() {
            if (confirm('¬øAbrir visualizaci√≥n en pantalla externa? Se abrir√° una ventana nueva.')) {
                let externalWindow;
                let leftPos = 0;
                let topPos = 0;
                let width = screen.availWidth;
                let height = screen.availHeight;
                
                if (screen.availLeft > 0) {
                    leftPos = screen.availLeft - width;
                } else if (screen.width > screen.availWidth) {
                    leftPos = screen.width;
                } else {
                    leftPos = (screen.width - 1024) / 2;
                    topPos = (screen.height - 768) / 2;
                    width = 1024;
                    height = 768;
                    console.log('Solo una pantalla detectada: Abriendo centrado');
                }
                
                const displayUrl = window.location.href.split('?')[0] + '?mode=display';
                
                externalWindow = window.open(
                    displayUrl,
                    'taekwondo-display',
                    `width=${width},height=${height},left=${leftPos},top=${topPos},fullscreen=yes,scrollbars=no,toolbar=no,menubar=no,resizable=yes`
                );
                
                if (externalWindow) {
                    console.log(`Ventana externa abierta en posici√≥n: left=${leftPos}, top=${topPos}`);
                    
                    if (broadcastChannel) {
                        broadcastChannel.postMessage({
                            type: 'update',
                            gameState: { ...gameState },
                            settings: { ...settings }
                        });
                    }
                    
                    setTimeout(() => {
                        if (externalWindow.closed) {
                            alert('Ventana bloqueada por pop-up blocker. Habilita pop-ups para este sitio y reintenta.');
                        }
                    }, 1000);
                } else {
                    alert('No se pudo abrir la ventana. Verifica pop-up blockers o permisos del navegador.');
                }
            }
        }

        function initDisplayMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const isDisplayMode = urlParams.get('mode') === 'display';
            
            if (isDisplayMode) {
                console.log('Modo Display activado: Ocultando controles y toolbar');
                document.getElementById('mainContainer').classList.add('display-mode');
                gameState.controlsVisible = false;
                document.getElementById('mainContainer').classList.add('controls-hidden');
                
                const timerElement = document.getElementById('timer');
                timerElement.onclick = null;
                timerElement.style.pointerEvents = 'none';
                console.log('Timer bloqueado en modo display');
                
                const displayBtn = document.querySelector('.toolbar-icon[title="Abrir en Pantalla Externa"]');
                if (displayBtn) displayBtn.style.display = 'none';
                
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Auto-fullscreen failed in display mode:', err);
                    });
                    }
                
                if (broadcastChannel) {
                    let lastTimerRunning = gameState.isTimerRunning;
                    
                    broadcastChannel.addEventListener('message', (event) => {
                        if (event.data.type === 'update') {
                            Object.assign(gameState, event.data.gameState);
                            Object.assign(settings, event.data.settings);
                            
                            if (gameState.isTimerRunning !== lastTimerRunning) {
                                if (!gameState.isTimerRunning) {
                                    console.log('Sync: Pausando timer local en display');
                                    pauseTimer();
                                } else {
                                    console.log('Sync: Iniciando timer local en display');
                                    startTimer();
                                }
                                lastTimerRunning = gameState.isTimerRunning;
                            }
                            
                            updateDisplay();
                        }
                    });
                    console.log('Escuchando sync en modo display');
                }
            } else {
                console.log('Modo Control: Controles visibles');
            }
        }

        // Keyboard shortcuts (mantener funcionalidad original)
        document.addEventListener('keydown', function(e) {
            const gameKeys = ['Space', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyA', 'KeyS', 'KeyD', 'KeyF'];
            if (gameKeys.includes(e.code)) {
                e.preventDefault();
            }

            switch (e.code) {
                case 'Space':
                    toggleTimer();
                    break;
                case 'KeyQ':
                    changePoints('red', 1);
                    break;
                case 'KeyW':
                    changePoints('red', -1);
                    break;
                case 'KeyE':
                    changePenalties('red', 1);
                    break;
                case 'KeyR':
                    changePenalties('red', -1);
                    break;
                case 'KeyA':
                    changePoints('blue', 1);
                    break;
                case 'KeyS':
                    changePoints('blue', -1);
                    break;
                case 'KeyD':
                    changePenalties('blue', 1);
                    break;
                case 'KeyF':
                    changePenalties('blue', -1);
                    break;
                case 'KeyH':
                    toggleControlsVisibility();
                    break;
                case 'KeyT':
                    gameState.timeRemaining = gameState.isRestTime ? settings.restTime : settings.roundTime;
                    pauseTimer();
                    updateDisplay();
                    break;
                case 'F11':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
                case 'Escape':
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.add('hidden');
                    });
                    break;
            }
        });

        // Prevent accidental page refresh
        window.addEventListener('beforeunload', function(e) {
            if (gameState.redScore > 0 || gameState.blueScore > 0 || 
                gameState.redPenalties > 0 || gameState.bluePenalties > 0) {
                e.preventDefault();
                e.returnValue = '¬øEst√° seguro de que desea salir? Se perder√° el progreso actual.';
                return e.returnValue;
            }
        });

        // Handle settings changes para multi-controller


        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            disableCache();
            loadSettings();
            updateDisplay();

            document.getElementById('enableMultiController').addEventListener('change', function(e) {
           settings.enableMultiController = e.target.checked;
           const controlsElement = document.getElementById('gamepadControls');
           if (e.target.checked) {
               console.log('Multi habilitado: Iniciando polling');
               controlsElement.style.display = 'block';
               stopPolling = false;  // Reanuda polling
               initMultiController();  // Re-inicia listeners de conexi√≥n
               pollMultipleGamepads();  // Inicia/reinicia el loop
           } else {
               console.log('Multi deshabilitado: Deteniendo polling');
               controlsElement.style.display = 'none';
               stopPolling = true;  // Detiene requestAnimationFrame
               connectedControllers = {};
               pendingActions = {};
               if (validationTimeout) clearTimeout(validationTimeout);
           }
           updateControllerStatus();
       });
            
            if (settings.enableMultiController) {
                initMultiController();
                updateControllerStatus();
            }
            
            requestLandscape();
            setTimeout(initDisplayMode, 100);
        });

        // Funci√≥n para verificar gamepad conectado peri√≥dicamente
        function checkGamepadConnection() {
            const gamepads = navigator.getGamepads();
            
            for (let i = 0; i < gamepads.length && i < 3; i++) {
                if (gamepads[i]) {
                    if (!connectedControllers[i]) {
                        connectedControllers[i] = {
                            connected: true,
                            gamepad: gamepads[i],
                            lastButtonStates: {}
                        };
                        console.log(`Control ${i} detectado:`, gamepads[i].id);
                        updateControllerStatus();
                    } else if (!connectedControllers[i].connected) {
                        connectedControllers[i].connected = true;
                        connectedControllers[i].gamepad = gamepads[i];
                        console.log(`Control ${i} reconectado`);
                        updateControllerStatus();
                    }
                } else if (connectedControllers[i] && connectedControllers[i].connected) {
                    connectedControllers[i].connected = false;
                    console.log(`Control ${i} desconectado`);
                    updateControllerStatus();
                }
            }
        }

        setInterval(checkGamepadConnection, 2000);

        function cleanupExpiredActions() {
            const now = Date.now();
            const maxAge = 5000;
            
            for (const actionKey in pendingActions) {
                if (now - pendingActions[actionKey].timestamp > maxAge) {
                    console.log(`Acci√≥n expirada eliminada: ${actionKey}`);
                    delete pendingActions[actionKey];
                }
            }
        }

        setInterval(cleanupExpiredActions, 3000);

    </script>
</body>
</html>
